<div class="app-container">
  <div class="app-header">
    <div class="header-content">
      <div class="logo-section">
        <mat-icon class="app-icon">school</mat-icon>
        <h1 class="app-title">{{ appInfo.NAME }}</h1>
        <span class="app-version">{{ appInfo.VERSION }}</span>
      </div>
      
      <div class="header-actions">
        <button mat-icon-button (click)="openSettings()" matTooltip="Settings" aria-label="Settings">
          <mat-icon>settings</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="app-content">
    <!-- Progress Stepper -->
    <div class="stepper-section">
      <mat-stepper #stepper orientation="horizontal" [selectedIndex]="currentStep - 1" linear="false">
        <!-- Step 1: Course Data -->
        <mat-step [completed]="currentStep > 1" [editable]="true">
          <ng-template matStepLabel>Course Data</ng-template>
          <div class="step-content">
            <h3>Upload Course Data</h3>
            <p class="step-description">Upload an Excel file with course information or use default courses.</p>
            
            <div class="action-buttons">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="triggerFileUpload()"
                [disabled]="isLoading">
                <mat-icon>upload_file</mat-icon>
                Upload Excel File
              </button>
              
              <button 
                mat-stroked-button 
                (click)="loadDefaultCourses()"
                [disabled]="isLoading">
                <mat-icon>list</mat-icon>
                Use Default Courses
              </button>
              
              <button 
                mat-stroked-button 
                color="accent"
                (click)="loadSampleSyllabusData()"
                [disabled]="isLoading">
                <mat-icon>article</mat-icon>
                Load Sample Syllabus
              </button>
              
              <button 
                mat-icon-button
                *ngIf="hasSyllabusData"
                (click)="clearSyllabusCache()"
                matTooltip="Clear syllabus cache"
                [disabled]="isLoading">
                <mat-icon>clear</mat-icon>
              </button>
            </div>

            <input 
              #fileInput 
              type="file" 
              accept=".xlsx,.xls,.csv" 
              (change)="onFileSelected($event)"
              style="display: none;">

            <div class="courses-preview" *ngIf="courses.length > 0">
              <h4>
                Loaded Courses ({{ courses.length }})
                <mat-icon 
                  *ngIf="hasSyllabusData" 
                  class="syllabus-indicator"
                  matTooltip="Click courses to view syllabus">
                  description
                </mat-icon>
              </h4>
              <div class="course-chips">
                <button 
                  mat-stroked-button
                  *ngFor="let course of courses.slice(0, 5)"
                  (click)="onCourseClick(course, $event)"
                  class="course-chip-button clickable"
                  [class.has-syllabus]="getCourseHasSyllabus(course)"
                  matTooltip="Click to view syllabus">
                  <mat-icon *ngIf="getCourseHasSyllabus(course)" class="chip-icon">article</mat-icon>
                  {{ course.label }}
                </button>
                <button 
                  mat-stroked-button
                  *ngIf="courses.length > 5"
                  (click)="showAllCoursesDialog()"
                  class="course-chip-button"
                  matTooltip="View all courses">
                  +{{ courses.length - 5 }} more
                </button>
              </div>
            </div>
          </div>
        </mat-step>

        <!-- Step 2: Job Titles -->
        <mat-step [completed]="currentStep > 2" [editable]="true">
          <ng-template matStepLabel>Job Titles</ng-template>
          <div class="step-content">
            <h3>Select Job Titles</h3>
            <p class="step-description">Choose job titles for career path analysis.</p>
            
            <div class="action-buttons">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="loadDefaultJobTitles()"
                [disabled]="isLoading || !canProceedToStep2 || !hasApiKey">
                <mat-icon>{{ isLoading ? 'hourglass_empty' : 'trending_up' }}</mat-icon>
                {{ isLoading ? 'Loading...' : 'Load Trending Jobs' }}
              </button>
              
              <button 
                mat-stroked-button 
                color="accent"
                (click)="refreshJobTitles()"
                [disabled]="isLoading || !canProceedToStep2 || !hasApiKey || jobTitles.length === 0">
                <mat-icon>{{ isLoading ? 'hourglass_empty' : 'refresh' }}</mat-icon>
                {{ isLoading ? 'Refreshing...' : 'Refresh Jobs' }}
              </button>
              
              <button 
                mat-stroked-button 
                (click)="openJobDialog()"
                [disabled]="isLoading">
                <mat-icon>add</mat-icon>
                Add Custom Jobs
              </button>
            </div>
            
            <div class="api-key-warning" *ngIf="!hasApiKey">
              <mat-icon color="warn">warning</mat-icon>
              <span>Please configure your Grok API key in settings to load job titles.</span>
            </div>

            <div class="jobs-preview" *ngIf="jobTitles.length > 0">
              <h4>Selected Job Titles ({{ jobTitles.length }})</h4>
              <div class="job-chips">
                <mat-chip-set>
                  <mat-chip *ngFor="let job of jobTitles.slice(0, 5)">
                    {{ job.label }}
                  </mat-chip>
                  <mat-chip *ngIf="jobTitles.length > 5">
                    +{{ jobTitles.length - 5 }} more
                  </mat-chip>
                </mat-chip-set>
              </div>
            </div>
          </div>
        </mat-step>

        <!-- Step 3: AI Analysis -->
        <mat-step [completed]="currentStep > 3" [editable]="true">
          <ng-template matStepLabel>AI Analysis</ng-template>
          <div class="step-content">
            <h3>Analyze Career Paths</h3>
            <p class="step-description">Let AI analyze job-to-course mappings with confidence scoring.</p>
            
            <div class="action-buttons">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="analyzeCareerPaths()"
                [disabled]="isLoading || !canAnalyzePaths || !hasApiKey">
                <mat-icon>psychology</mat-icon>
                Start AI Analysis
              </button>
            </div>

            <div class="api-key-warning" *ngIf="!hasApiKey">
              <mat-icon color="warn">warning</mat-icon>
              <span>Please configure your Grok API key in settings before analysis.</span>
            </div>

            <div class="analysis-results" *ngIf="currentStep > 3">
              <h4>Analysis Results</h4>
              <div class="confidence-display">
                <span class="confidence-label">Overall Confidence:</span>
                <span class="confidence-value" [ngClass]="getConfidenceClass(overallConfidence)">
                  {{ (overallConfidence * 100).toFixed(0) }}%
                </span>
              </div>
              
              <div class="results-summary">
                <div class="summary-item">
                  <span class="summary-label">Mapped Jobs:</span>
                  <span class="summary-value">{{ Object.keys(mappings).length }}</span>
                </div>
                <div class="summary-item">
                  <span class="summary-label">Suggested Courses:</span>
                  <span class="summary-value">{{ suggestedCourses.length }}</span>
                </div>
              </div>
            </div>
          </div>
        </mat-step>

        <!-- Step 4: Review -->
        <mat-step [completed]="false">
          <ng-template matStepLabel>Review</ng-template>
          <div class="step-content">
            <h3>Review Mappings</h3>
            <p class="step-description">Review and adjust the AI-generated career path mappings.</p>
            
            <!-- Enhanced Results Display -->
            <div class="results-section" *ngIf="currentStep === 4">
              <!-- Export Button -->
              <div class="export-actions">
                <button 
                  mat-raised-button 
                  color="accent"
                  (click)="exportResultsToExcel()"
                  [disabled]="Object.keys(mappings).length === 0 && suggestedCourses.length === 0">
                  <mat-icon>download</mat-icon>
                  Export Results to Excel
                </button>
              </div>

              <!-- Summary Cards -->
              <div class="summary-cards">
                <mat-card class="summary-card">
                  <mat-card-content>
                    <div class="summary-number">{{ jobTitles.length }}</div>
                    <div class="summary-label">Job Titles</div>
                  </mat-card-content>
                </mat-card>
                <mat-card class="summary-card">
                  <mat-card-content>
                    <div class="summary-number">{{ courses.length }}</div>
                    <div class="summary-label">Available Courses</div>
                  </mat-card-content>
                </mat-card>
                <mat-card class="summary-card matched">
                  <mat-card-content>
                    <div class="summary-number">{{ Object.keys(mappings).length }}</div>
                    <div class="summary-label">Matched Courses</div>
                  </mat-card-content>
                </mat-card>
                <mat-card class="summary-card suggested">
                  <mat-card-content>
                    <div class="summary-number">{{ suggestedCourses.length }}</div>
                    <div class="summary-label">New Suggestions</div>
                  </mat-card-content>
                </mat-card>
              </div>

              <!-- Matched Courses Display -->
              <div class="matched-courses-preview" *ngIf="Object.keys(mappings).length > 0">
                <h4>
                  <mat-icon class="section-icon matched-icon">check_circle</mat-icon>
                  Matched Courses for Your Career Path
                </h4>
                
                <div class="course-chips">
                  <button 
                    mat-stroked-button
                    *ngFor="let mapping of mappingsArray.slice(0, 8)"
                    (click)="onCourseClickFromArray(mapping.course, mapping.job)"
                    class="course-chip-button matched-course clickable"
                    matTooltip="Click to view syllabus - Matched for: {{ mapping.job }}">
                    <mat-icon class="chip-icon">done</mat-icon>
                    {{ mapping.course }}
                  </button>
                  <button 
                    mat-stroked-button
                    *ngIf="Object.keys(mappings).length > 8"
                    (click)="showAllMappings()"
                    class="course-chip-button">
                    +{{ Object.keys(mappings).length - 8 }} more
                  </button>
                </div>
              </div>

              <!-- Suggested New Courses Display -->
              <div class="suggested-courses-preview" *ngIf="suggestedCourses.length > 0">
                <h4>
                  <mat-icon class="section-icon suggested-icon">lightbulb</mat-icon>
                  Recommended Additional Courses
                </h4>
                <div class="course-chips">
                  <button 
                    mat-stroked-button
                    *ngFor="let suggestion of suggestedCourses.slice(0, 6)"
                    (click)="onSuggestedCourseClick(suggestion)"
                    class="course-chip-button suggested-course"
                    [class.confidence-high]="suggestion.confidence >= 0.8"
                    [class.confidence-medium]="suggestion.confidence >= 0.6 && suggestion.confidence < 0.8"
                    [class.confidence-low]="suggestion.confidence < 0.6"
                    [class.enhanced-syllabus]="suggestion.improvement_type === 'enhanced_syllabus'"
                    [matTooltip]="getSuggestionTooltip(suggestion)">
                    <mat-icon class="chip-icon">{{ getSuggestionIcon(suggestion) }}</mat-icon>
                    {{ suggestion.title }}
                    <span class="confidence-badge">{{ (suggestion.confidence * 100).toFixed(0) }}%</span>
                  </button>
                  <button 
                    mat-stroked-button
                    *ngIf="suggestedCourses.length > 6"
                    (click)="showAllSuggestions()"
                    class="course-chip-button">
                    +{{ suggestedCourses.length - 6 }} more
                  </button>
                </div>
              </div>

              <!-- Job to Course Mapping Details -->
              <div class="mapping-details" *ngIf="Object.keys(mappings).length > 0">
                <h4>
                  <mat-icon class="section-icon">swap_horiz</mat-icon>
                  Job-to-Course Mapping Details
                </h4>
                <div class="mapping-grid">
                  <div class="mapping-card" *ngFor="let mapping of mappingsArray.slice(0, 5)">
                    <div class="job-section">
                      <mat-icon>work</mat-icon>
                      <span class="job-title">{{ mapping.job }}</span>
                    </div>
                    <mat-icon class="mapping-arrow">arrow_forward</mat-icon>
                    <div class="course-section clickable" 
                         (click)="onCourseClickFromArray(mapping.course, mapping.job)"
                         matTooltip="Click to view {{ mapping.course }} syllabus">
                      <mat-icon>school</mat-icon>
                      <span class="course-title">{{ mapping.course }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </mat-step>
      </mat-stepper>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-content">
        <mat-icon class="status-icon" [ngClass]="getStatusIconClass()">
          {{ getStatusIcon() }}
        </mat-icon>
        <span class="status-message">{{ statusMessage }}</span>
        
        <div class="status-actions">
          <button 
            mat-icon-button 
            *ngIf="isLoading"
            (click)="showProgressDialog = true"
            matTooltip="Show Progress"
            aria-label="Show Progress">
            <mat-icon>info</mat-icon>
          </button>
        </div>
      </div>
      
      <mat-progress-bar 
        *ngIf="isLoading"
        mode="indeterminate"
        class="status-progress">
      </mat-progress-bar>
    </div>
  </div>
</div>

<!-- Progress Dialog -->
<div class="progress-overlay" *ngIf="showProgressDialog && isLoading">
  <mat-card class="progress-dialog">
    <mat-card-header>
      <mat-card-title>Processing</mat-card-title>
    </mat-card-header>
    
    <mat-card-content>
      <div class="progress-content">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <p>{{ processingMessage }}</p>
        
        <div class="logs-section" *ngIf="logs.length > 0">
          <h4>Progress Log:</h4>
          <div class="logs-container">
            <div 
              *ngFor="let log of logs.slice(-5)" 
              class="log-entry"
              [ngClass]="'log-' + log.type">
              <span class="log-timestamp">{{ formatLogTime(log.timestamp) }}</span>
              <span class="log-message">{{ log.message }}</span>
            </div>
          </div>
        </div>
      </div>
    </mat-card-content>
    
    <mat-card-actions>
      <button mat-button (click)="showProgressDialog = false">
        Hide
      </button>
    </mat-card-actions>
  </mat-card>
</div>

<router-outlet />