<div class="app-container">
  <div class="app-header">
    <div class="header-content">
      <div class="logo-section">
        <mat-icon class="app-icon">school</mat-icon>
        <h1 class="app-title">{{ appInfo.NAME }}</h1>
        <span class="app-version">{{ appInfo.VERSION }}</span>
      </div>
      
      <div class="header-actions">
        <button mat-icon-button (click)="openSettings()" aria-label="Settings">
          <mat-icon>settings</mat-icon>
        </button>
      </div>
    </div>
  </div>

  <div class="app-content">
    <!-- Progress Stepper -->
    <div class="stepper-section">
      <mat-stepper #stepper orientation="horizontal" [selectedIndex]="currentStep - 1" linear="false">
        <!-- Step 1: Course Data -->
        <mat-step [completed]="currentStep > 1" [editable]="true">
          <ng-template matStepLabel>Course Data</ng-template>
          <div class="step-content">
            <h3>Upload Course Data</h3>
            <p class="step-description">Upload course data (Excel or PDF syllabus) or use default courses.</p>
            
            <div class="action-buttons">
              <button
                mat-stroked-button
                color="primary"
                (click)="triggerFileUpload()"
                [disabled]="isLoading">
                <mat-icon>upload_file</mat-icon>
                Upload Files (Excel/PDF)
              </button>
              
              <button 
                mat-stroked-button 
                (click)="loadDefaultCourses()"
                [disabled]="isLoading">
                <mat-icon>list</mat-icon>
                Use Default Courses
              </button>
              
              <button 
                mat-stroked-button 
                color="accent"
                (click)="loadSampleSyllabusData()"
                [disabled]="isLoading">
                <mat-icon>article</mat-icon>
                Load Sample Syllabus
              </button>
              
              <button 
                mat-icon-button
                *ngIf="hasSyllabusData"
                (click)="clearSyllabusCache()"
                matTooltip="Clear syllabus cache"
                [disabled]="isLoading">
                <mat-icon>clear</mat-icon>
              </button>
            </div>

            <input
              #fileInput
              type="file"
              accept=".xlsx,.xls,.csv,.pdf"
              multiple
              (change)="onFileSelected($event)"
              style="display: none;">

            <div class="empty-state" *ngIf="courses.length === 0">
              <mat-icon class="empty-state-icon">school</mat-icon>
              <h4>No Courses Loaded</h4>
              <p>Upload course data (Excel or PDF) or use default courses to get started</p>
            </div>

            <div class="courses-preview" *ngIf="courses.length > 0">
              <h4>
                Loaded Courses ({{ courses.length }})
                <mat-icon
                  *ngIf="hasSyllabusData"
                  class="syllabus-indicator"
                  matTooltip="Click courses to view syllabus">
                  description
                </mat-icon>
              </h4>
              <div class="course-chips">
                <button
                  mat-stroked-button
                  *ngFor="let course of (showAllCourses ? courses : courses.slice(0, 5))"
                  (click)="onCourseClick(course, $event)"
                  class="course-chip-button clickable"
                  [class.has-syllabus]="getCourseHasSyllabus(course)">
                  <mat-icon *ngIf="getCourseHasSyllabus(course)" class="chip-icon">article</mat-icon>
                  {{ course.label }}
                </button>
                <button
                  mat-stroked-button
                  *ngIf="courses.length > 5"
                  (click)="showAllCoursesDialog()"
                  class="course-chip-button">
                  {{ showAllCourses ? 'Show less' : '+' + (courses.length - 5) + ' more' }}
                </button>
              </div>
            </div>

            <!-- Step Navigation -->
            <div class="step-navigation">
              <button
                mat-raised-button
                color="primary"
                (click)="goToNextStep()"
                [disabled]="!canGoToNextStep() || isLoading">
                Next
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>
        </mat-step>

        <!-- Step 2: Job Titles -->
        <mat-step [completed]="currentStep > 2" [editable]="true">
          <ng-template matStepLabel>Job Titles</ng-template>
          <div class="step-content">
            <h3>Select Job Titles</h3>
            <p class="step-description">Choose job titles for career path analysis.</p>
            
            <div class="action-buttons">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="loadDefaultJobTitles()"
                [disabled]="isLoading || !canProceedToStep2 || !hasApiKey">
                <mat-icon>{{ isLoading ? 'hourglass_empty' : 'trending_up' }}</mat-icon>
                {{ isLoading ? 'Loading...' : 'Load Trending Jobs' }}
              </button>
              
              <button 
                mat-stroked-button 
                color="accent"
                (click)="refreshJobTitles()"
                [disabled]="isLoading || !canProceedToStep2 || !hasApiKey || jobTitles.length === 0">
                <mat-icon>{{ isLoading ? 'hourglass_empty' : 'refresh' }}</mat-icon>
                {{ isLoading ? 'Refreshing...' : 'Refresh Jobs' }}
              </button>
              
              <button 
                mat-stroked-button 
                (click)="openJobDialog()"
                [disabled]="isLoading">
                <mat-icon>add</mat-icon>
                Add Custom Jobs
              </button>
            </div>
            
            <div class="api-key-warning" *ngIf="!hasApiKey">
              <mat-icon color="warn">warning</mat-icon>
              <span>Please configure your Grok API key in settings to load job titles.</span>
            </div>

            <div class="jobs-preview" *ngIf="jobTitles.length > 0">
              <h4>Selected Job Titles ({{ jobTitles.length }})</h4>
              <div class="job-chips">
                <mat-chip-set>
                  <mat-chip
                    *ngFor="let job of (showAllJobsExpanded ? jobTitles : jobTitles.slice(0, 5))"
                    (click)="showJobDetails(job)"
                    class="clickable-chip"
                    [matTooltip]="'Click to view details'"
                    matTooltipPosition="above">
                    <mat-icon *ngIf="job.source === 'live'" class="job-source-icon">trending_up</mat-icon>
                    <span class="job-chip-content">
                      {{ job.label }}
                      <span *ngIf="job.company" class="job-company">@ {{ job.company }}</span>
                    </span>
                    <mat-icon *ngIf="job.description" class="job-info-icon">info</mat-icon>
                  </mat-chip>
                  <mat-chip
                    *ngIf="jobTitles.length > 5"
                    (click)="showAllJobs()">
                    {{ showAllJobsExpanded ? 'Show less' : '+' + (jobTitles.length - 5) + ' more' }}
                  </mat-chip>
                </mat-chip-set>
              </div>
            </div>

            <!-- Step Navigation -->
            <div class="step-navigation">
              <button
                mat-stroked-button
                (click)="goToPreviousStep()"
                [disabled]="isLoading">
                <mat-icon>arrow_back</mat-icon>
                Previous
              </button>
              <button
                mat-raised-button
                color="primary"
                (click)="goToNextStep()"
                [disabled]="!canGoToNextStep() || isLoading">
                Next
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>
        </mat-step>

        <!-- Step 3: AI Analysis -->
        <mat-step [completed]="currentStep > 3" [editable]="true">
          <ng-template matStepLabel>AI Analysis</ng-template>
          <div class="step-content">
            <h3>Analyze Career Paths</h3>
            <p class="step-description">Let AI analyze job-to-course mappings with confidence scoring.</p>
            
            <div class="action-buttons">
              <button 
                mat-raised-button 
                color="primary" 
                (click)="analyzeCareerPaths()"
                [disabled]="isLoading || !canAnalyzePaths || !hasApiKey">
                <mat-icon>psychology</mat-icon>
                Start AI Analysis
              </button>
            </div>

            <div class="api-key-warning" *ngIf="!hasApiKey">
              <mat-icon color="warn">warning</mat-icon>
              <span>Please configure your Grok API key in settings before analysis.</span>
            </div>

            <div class="analysis-results" *ngIf="currentStep > 3">
              <h4>
                <mat-icon class="section-icon">analytics</mat-icon>
                Analysis Dashboard
              </h4>

              <!-- Statistics Overview -->
              <div class="stats-overview">
                <div class="stat-card mapped">
                  <mat-icon>check_circle</mat-icon>
                  <div class="stat-content">
                    <span class="stat-value">{{ Object.keys(mappings).length }}</span>
                    <span class="stat-label">Jobs Mapped</span>
                  </div>
                </div>
                <div class="stat-card unmapped">
                  <mat-icon>pending</mat-icon>
                  <div class="stat-content">
                    <span class="stat-value">{{ getUnmappedJobsCount() }}</span>
                    <span class="stat-label">Jobs Unmapped</span>
                  </div>
                </div>
                <div class="stat-card suggested">
                  <mat-icon>lightbulb</mat-icon>
                  <div class="stat-content">
                    <span class="stat-value">{{ suggestedCourses.length }}</span>
                    <span class="stat-label">New Courses Suggested</span>
                  </div>
                </div>
                <div class="stat-card total">
                  <mat-icon>work</mat-icon>
                  <div class="stat-content">
                    <span class="stat-value">{{ jobTitles.length }}</span>
                    <span class="stat-label">Total Jobs Analyzed</span>
                  </div>
                </div>
              </div>

              <!-- Coverage Visualization -->
              <div class="coverage-section" *ngIf="Object.keys(mappings).length > 0">
                <h5>
                  <mat-icon>bar_chart</mat-icon>
                  Curriculum Coverage
                </h5>
                <div class="coverage-bars">
                  <div class="coverage-item" *ngFor="let job of Object.keys(mappings)">
                    <div class="coverage-header">
                      <span class="job-title">{{ job }}</span>
                      <span class="coverage-percent">{{ getMappingCoveragePercent(job) }}%</span>
                    </div>
                    <div class="coverage-bar-container">
                      <div class="coverage-bar"
                           [style.width.%]="getMappingCoveragePercent(job)"
                           [class.high]="getMappingCoveragePercent(job) >= 80"
                           [class.medium]="getMappingCoveragePercent(job) >= 50 && getMappingCoveragePercent(job) < 80"
                           [class.low]="getMappingCoveragePercent(job) < 50">
                      </div>
                    </div>
                    <div class="coverage-details">
                      <span class="mapped-course">{{ getMappedCourseLabel(job) }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Skills Gap Analysis -->
              <div class="skills-gap-section" *ngIf="hasJobDescriptions()">
                <h5>
                  <mat-icon>psychology</mat-icon>
                  Skills Gap Analysis
                </h5>
                <div class="gap-analysis-grid">
                  <div class="gap-card" *ngFor="let job of getJobsWithDescriptions()">
                    <div class="gap-card-header">
                      <span class="gap-job-title">{{ job.label }}</span>
                      <mat-icon class="expand-icon">expand_more</mat-icon>
                    </div>
                    <div class="gap-card-body">
                      <div class="skills-covered" *ngIf="getSkillsCovered(job).length > 0">
                        <span class="skills-section-title">
                          <mat-icon>check</mat-icon>
                          Skills Covered
                        </span>
                        <div class="skill-chips">
                          <span class="skill-chip covered" *ngFor="let skill of getSkillsCovered(job).slice(0, 5)">
                            {{ skill }}
                          </span>
                          <span class="skill-more" *ngIf="getSkillsCovered(job).length > 5">
                            +{{ getSkillsCovered(job).length - 5 }} more
                          </span>
                        </div>
                      </div>
                      <div class="skills-missing" *ngIf="getSkillsGap(job).length > 0">
                        <span class="skills-section-title">
                          <mat-icon>priority_high</mat-icon>
                          Skills Gap
                        </span>
                        <div class="skill-chips">
                          <span class="skill-chip missing" *ngFor="let skill of getSkillsGap(job).slice(0, 5)">
                            {{ skill }}
                          </span>
                          <span class="skill-more" *ngIf="getSkillsGap(job).length > 5">
                            +{{ getSkillsGap(job).length - 5 }} more
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Step Navigation -->
            <div class="step-navigation">
              <button
                mat-stroked-button
                (click)="goToPreviousStep()"
                [disabled]="isLoading">
                <mat-icon>arrow_back</mat-icon>
                Previous
              </button>
              <button
                mat-raised-button
                color="primary"
                (click)="goToNextStep()"
                [disabled]="!canGoToNextStep() || isLoading">
                Next
                <mat-icon>arrow_forward</mat-icon>
              </button>
            </div>
          </div>
        </mat-step>

        <!-- Step 4: Review -->
        <mat-step [completed]="false">
          <ng-template matStepLabel>Review</ng-template>
          <div class="step-content">
            <h3>Review Mappings</h3>
            <p class="step-description">Review and adjust the AI-generated career path mappings.</p>
            
            <!-- Enhanced Results Display -->
            <div class="results-section" *ngIf="currentStep === 4">
              <!-- Export Button -->
              <div class="export-actions">
                <button 
                  mat-raised-button 
                  color="accent"
                  (click)="exportResultsToExcel()"
                  [disabled]="Object.keys(mappings).length === 0 && suggestedCourses.length === 0">
                  <mat-icon>download</mat-icon>
                  Export Results to Excel
                </button>
              </div>

              <!-- Summary Cards -->
              <div class="summary-cards">
                <mat-card class="summary-card">
                  <mat-card-content>
                    <div class="summary-number">{{ jobTitles.length }}</div>
                    <div class="summary-label">Job Titles</div>
                  </mat-card-content>
                </mat-card>
                <mat-card class="summary-card">
                  <mat-card-content>
                    <div class="summary-number">{{ courses.length }}</div>
                    <div class="summary-label">Available Courses</div>
                  </mat-card-content>
                </mat-card>
                <mat-card class="summary-card matched">
                  <mat-card-content>
                    <div class="summary-number">{{ Object.keys(mappings).length }}</div>
                    <div class="summary-label">Matched Courses</div>
                  </mat-card-content>
                </mat-card>
                <mat-card class="summary-card suggested">
                  <mat-card-content>
                    <div class="summary-number">{{ suggestedCourses.length }}</div>
                    <div class="summary-label">New Suggestions</div>
                  </mat-card-content>
                </mat-card>
              </div>

              <!-- Matched Courses Display -->
              <div class="matched-courses-preview" *ngIf="Object.keys(mappings).length > 0">
                <h4>
                  <mat-icon class="section-icon matched-icon">check_circle</mat-icon>
                  Matched Courses for Your Career Path
                </h4>
                
                <div class="course-chips">
                  <button 
                    mat-stroked-button
                    *ngFor="let mapping of mappingsArray.slice(0, 8)"
                    (click)="onCourseClickFromArray(mapping.course, mapping.job)"
                    class="course-chip-button matched-course clickable">
                    <mat-icon class="chip-icon">done</mat-icon>
                    {{ getCourseLabelSafe(mapping.course) }}
                  </button>
                  <button 
                    mat-stroked-button
                    *ngIf="Object.keys(mappings).length > 8"
                    (click)="showAllMappings()"
                    class="course-chip-button">
                    +{{ Object.keys(mappings).length - 8 }} more
                  </button>
                </div>
              </div>

              <!-- Suggested New Courses Display -->
              <div class="suggested-courses-preview" *ngIf="suggestedCourses.length > 0">
                <h4>
                  <mat-icon class="section-icon suggested-icon">lightbulb</mat-icon>
                  Recommended Additional Courses
                </h4>
                <div class="course-chips">
                  <button
                    mat-stroked-button
                    *ngFor="let suggestion of suggestedCourses.slice(0, 6)"
                    (click)="onSuggestedCourseClick(suggestion)"
                    class="course-chip-button suggested-course"
                    [class.enhanced-syllabus]="suggestion.improvement_type === 'enhanced_syllabus'"
                    [matTooltip]="getSuggestionTooltip(suggestion)">
                    <mat-icon class="chip-icon">{{ getSuggestionIcon(suggestion) }}</mat-icon>
                    {{ suggestion.title }}
                  </button>
                  <button 
                    mat-stroked-button
                    *ngIf="suggestedCourses.length > 6"
                    (click)="showAllSuggestions()"
                    class="course-chip-button">
                    +{{ suggestedCourses.length - 6 }} more
                  </button>
                </div>
              </div>

              <!-- Job to Course Mapping Details -->
              <div class="mapping-details" *ngIf="Object.keys(mappings).length > 0">
                <h4>
                  <mat-icon class="section-icon">swap_horiz</mat-icon>
                  Job-to-Course Mapping Details
                </h4>
                <div class="mapping-grid">
                  <div class="mapping-card" *ngFor="let mapping of mappingsArray.slice(0, 5)">
                    <div class="job-section clickable" 
                         (click)="showJobDetailsByLabel(mapping.job)"
                         matTooltip="Click to view job details">
                      <mat-icon>work</mat-icon>
                      <span class="job-title">{{ mapping.job }}</span>
                      <mat-icon *ngIf="hasJobDescription(mapping.job)" class="job-info-icon">info</mat-icon>
                    </div>
                    <mat-icon class="mapping-arrow">arrow_forward</mat-icon>
                    <div class="course-section clickable"
                         (click)="onCourseClickFromArray(mapping.course, mapping.job)"
                         matTooltip="Click to view {{ getCourseLabelSafe(mapping.course) }} syllabus">
                      <mat-icon>school</mat-icon>
                      <span class="course-title">{{ getCourseLabelSafe(mapping.course) }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step Navigation -->
              <div class="step-navigation">
                <button
                  mat-stroked-button
                  (click)="goToPreviousStep()"
                  [disabled]="isLoading">
                  <mat-icon>arrow_back</mat-icon>
                  Previous
                </button>
              </div>
            </div>
          </div>
        </mat-step>
      </mat-stepper>
    </div>

    <!-- Status Bar -->
    <div class="status-bar" *ngIf="showStatusBar" [class]="getStatusBarClass()" [class.status-bar-hiding]="isStatusBarHiding">
      <div class="status-content">
        <!-- Show spinner when loading, icon otherwise -->
        <mat-spinner *ngIf="isLoading" diameter="20" class="status-spinner"></mat-spinner>
        <mat-icon *ngIf="!isLoading" class="status-icon" [ngClass]="getStatusIconClass()">
          {{ getStatusIcon() }}
        </mat-icon>
        <span class="status-message">{{ statusMessage }}</span>
      </div>

      <mat-progress-bar
        *ngIf="isLoading"
        mode="indeterminate"
        class="status-progress">
      </mat-progress-bar>
    </div>

    <!-- Copyright Footer -->
    <div class="copyright-footer">
      <span class="footer-text">
        By Venkat L. Turlapati | Property of University of Texas at Dallas
      </span>
    </div>
  </div>
</div>

<router-outlet />